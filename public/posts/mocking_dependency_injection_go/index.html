<!DOCTYPE html>
<html><head>
<title>Mocking with dependency injection in Go</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="A common pattern with an interface to allow for passing mocks in unit tests.">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">















  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.d22489d435cad4d1be8830b34963ea0efb4235e61424399eafba69f35d873302.css" integrity="sha256-0iSJ1DXK1NG&#43;iDCzSWPqDvtCNeYUJDmer7pp812HMwI=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/articles">
                    Articles
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#a-scenario" class="nav-a-scenario">
									A scenario
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#the-problem" class="nav-the-problem">
									The problem
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#the-solution" class="nav-the-solution">
									The solution?
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://example.org/">
            jamesatk.in
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://example.org/">
        <div class="single-column-header-title">jamesatk.in</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    Mocking with dependency injection in Go
                    
                    <div class="post-subtitle">
                        A common pattern with an interface to allow for passing mocks in unit tests.
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2024-09-12 00:00
                        </time>
                        

                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/go">go</a>
                                &nbsp;
                            
                                <a href="/tags/unit-testing">unit-testing</a>
                                &nbsp;
                            
                                <a href="/tags/mocking">mocking</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <p>This is a pattern I&rsquo;ve used quite a bit at work and is pretty useful for unit testing.</p>
<h1 id="a-scenario">A scenario</h1>
<p>Let&rsquo;s suppose we have a service <code>Service</code> which provides various bits of functionality.
One such function is registering users.
This interfaces with Amazon&rsquo;s <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html">Cognito</a> service for identity management, as well as doing other things, like maybe saving them to a database:</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">type</span> Service <span style="color:#fc5fa3">struct</span>{
</span></span><span style="display:flex;"><span>	CognitoClient *cognitoidentityprovider.Client
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// ...Other fields
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> <span style="color:#41a1c0">New</span>() *Service {
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">return</span> &amp;Service{
</span></span><span style="display:flex;"><span>		CognitoClient: cognitoidentityprovider.<span style="color:#41a1c0">New</span>(),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> (s *Service) <span style="color:#41a1c0">RegisterUser</span>(ctx context.Context, params RegisterParams) <span style="color:#fc5fa3">error</span> {
</span></span><span style="display:flex;"><span>	slog.<span style="color:#41a1c0">Info</span>(<span style="color:#fc6a5d">&#34;registering user&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// Confirm user on Cognito
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	_, err := s.CognitoClient.<span style="color:#41a1c0">ConfirmSignUp</span>(
</span></span><span style="display:flex;"><span>		ctx, 
</span></span><span style="display:flex;"><span>		<span style="color:#fc6a5d">&#34;eu-west-2&#34;</span>,
</span></span><span style="display:flex;"><span>		&amp;cognitoidentityprovider.ConfirmSignUpInput{
</span></span><span style="display:flex;"><span>		    ClientId:         &amp;params.ClientID,
</span></span><span style="display:flex;"><span>		    ConfirmationCode: &amp;params.Code,  
</span></span><span style="display:flex;"><span>		    Username:         &amp;params.Username,
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">if</span> err != <span style="color:#fc5fa3">nil</span> {
</span></span><span style="display:flex;"><span>		slog.<span style="color:#41a1c0">Error</span>(<span style="color:#fc6a5d">&#34;failed to confirm user sign-up&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#fc5fa3">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// ...Do other stuff with database here
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">return</span> <span style="color:#fc5fa3">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s write a simple test for this now.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">package</span> service_test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> <span style="color:#41a1c0">Test_RegisterUserSuccess</span>(t *testing.T) {
</span></span><span style="display:flex;"><span>	s := service.<span style="color:#41a1c0">New</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	testParams := RegisterParams{
</span></span><span style="display:flex;"><span>		<span style="color:#6c7986">// ...Fill with correct values
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	err := s.<span style="color:#41a1c0">RegisterUser</span>(context.<span style="color:#41a1c0">Background</span>(), testParams)
</span></span><span style="display:flex;"><span>	require.<span style="color:#41a1c0">NoError</span>(t, err)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="the-problem">The problem</h1>
<p>What happens now?
The test will attempt to reach a real version of AWS Cognito. This is undesirable for a couple of reasons.</p>
<p>Firstly, it relies on an actual instance of Cognito being live and hosted. Behemoth that it is, AWS is so widely used that we can consider it reliable, but a smaller service may not be. Network connections, latency and service uptime can all make tests non-hermetic, not to mention AWS&rsquo; notorious pricing structure being an unnecessary overhead.</p>
<figure><img src="/images/chatgpt_aws_joke.png"
         alt="(I think ChatGPT&amp;rsquo;s humour needs some work but it gets the point across.)"/><figcaption>
            <p><em>(I think ChatGPT&rsquo;s humour needs some work but it gets the point across.)</em></p>
        </figcaption>
</figure>

<p>Secondly, it violates the principle of unit tests since the bounds of the test exceed the unit of code under test (the <code>RegisterUser</code> function).</p>
<h1 id="the-solution">The solution?</h1>
<p><strong>Dependency injection.</strong></p>
<p>At the time of writing, Wikipedia defines <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> as</p>
<blockquote>
<p>a programming technique in which an object or function receives other objects or functions that it requires, as opposed to creating them internally</p>
</blockquote>
<p>Using this principle we can <em>inject</em> the <em>dependency</em> of the Cognito client into the service of the constructor:</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> <span style="color:#41a1c0">New</span>(cognitoClient *cognitoidentityprovider.Client) *Service {
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">return</span> &amp;Service{
</span></span><span style="display:flex;"><span>		CognitoClient: cognitoClient,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we can configure our client however we like and pass it through. This allows for differently configured clients in the real code and the test, however we still have the problem that it&rsquo;s hitting the <em>genuine</em> Cognito service.</p>
<p>Rather than using a concrete Cognito client (which is rigidly inflexible for our purposes), we can inject something that <em>looks like a Cognito client</em> instead. We can accomplish this by writing an interface to mimic the desired functionality. This provides a contract that can accommodate any passed dependency - provided it fulfils the interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">type</span> IdentityProvider <span style="color:#fc5fa3">interface</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#41a1c0">ConfirmSignUp</span>(ctx context.Context, params *cognitoidentityprovider.ConfirmSignUpInput, optFns ...<span style="color:#fc5fa3">func</span>(*cognitoidentityprovider.Options)) (*cognitoidentityprovider.ConfirmSignUpOutput, <span style="color:#fc5fa3">error</span>)  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And then updating the <code>Service</code> and constructor:</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">type</span> Service <span style="color:#fc5fa3">struct</span>{
</span></span><span style="display:flex;"><span>	CognitoClient IdentityProvider
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// ...Other fields
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> <span style="color:#41a1c0">New</span>(cognitoClient IdentityProvider) *Service {
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">return</span> &amp;Service{
</span></span><span style="display:flex;"><span>		CognitoClient: cognitoClient,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can then revisit the tests, setting up our mocks for Cognito. Since these also fulfil the <code>IdentityProvider</code> contract, they can be passed to <code>Service.New()</code>.</p>
<p>(You can substitute whatever mocks you like here, I like the <a href="https://github.com/uber-go/mock"><code>gomock</code> </a> library as it generates them all for you.)</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#1f1f24;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fc5fa3">package</span> service_test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fc5fa3">func</span> <span style="color:#41a1c0">Test_RegisterUserSuccess</span>(t *testing.T) {
</span></span><span style="display:flex;"><span>	testParams := RegisterParams{
</span></span><span style="display:flex;"><span>		<span style="color:#6c7986">// ...Fill with correct values
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// Start gomock Controller
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	ctrl := gomock.<span style="color:#41a1c0">NewController</span>(t)  
</span></span><span style="display:flex;"><span>	<span style="color:#fc5fa3">defer</span> ctrl.<span style="color:#41a1c0">Finish</span>()  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// Initialise mock
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	mockIdentityProvider := mocks.<span style="color:#41a1c0">NewMockIdentityProvider</span>(ctrl)  
</span></span><span style="display:flex;"><span>	mockIdentityProvider.<span style="color:#41a1c0">EXPECT</span>().<span style="color:#41a1c0">ConfirmSignUp</span>(gomock.<span style="color:#41a1c0">Any</span>(), <span style="color:#fc6a5d">&#34;eu-west-2&#34;</span>, &amp;cognitoidentityprovider.ConfirmSignUpInput{  
</span></span><span style="display:flex;"><span>	    ClientId:         &amp;testParams.ClientID,  
</span></span><span style="display:flex;"><span>	    ConfirmationCode: &amp;testParams.Code,  
</span></span><span style="display:flex;"><span>	    Username:         &amp;testParams.Username,  
</span></span><span style="display:flex;"><span>	}).<span style="color:#41a1c0">Return</span>(<span style="color:#fc5fa3">nil</span>, <span style="color:#fc5fa3">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6c7986">// Pass the mock
</span></span></span><span style="display:flex;"><span><span style="color:#6c7986"></span>	s := service.<span style="color:#41a1c0">New</span>(mockIdentityProvider)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	err := s.<span style="color:#41a1c0">RegisterUser</span>(context.<span style="color:#41a1c0">Background</span>(), testParams)
</span></span><span style="display:flex;"><span>	require.<span style="color:#41a1c0">NoError</span>(t, err)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A handy side-effect of using the <code>IdentityProvider</code> interface is that it opens the door for us to add functionality around the Cognito calls in future if we wished. We could write our own <a href="https://en.wikipedia.org/wiki/Shim_(computing)">shim</a> struct around this to provide extra logging or metric exporting, for instance.</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2024-09-12</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="/posts/navidrome_raspberry_pi/">
			Previous<br>Self-hosted music streaming on a Raspberry Pi
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://example.org/">
    
        <div class="nav-title">
            jamesatk.in
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/articles">
                Articles
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 jamesatk.in
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#a-scenario" class="nav-a-scenario">
									A scenario
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#the-problem" class="nav-the-problem">
									The problem
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#the-solution" class="nav-the-solution">
									The solution?
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>

<div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2024 jamesatk.in
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
